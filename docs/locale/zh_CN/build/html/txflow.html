

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>交易流程 &mdash; hyperledger-fabricdocs master documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="服务发现" href="discovery-overview.html" />
    <link rel="prev" title="Hyperledger Fabric SDK" href="fabric-sdks.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          


          
            <a href="index.html" class="icon icon-home"> hyperledger-fabricdocs
          

          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

<br><img style="background-color: #fff; height: unset; width: unset;" alt="Hyperledger Fabric" src=_images/hyperledger_fabric_logo_color.png />
<br>
<a href="https://github.com/hyperledger/fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="GitHub" src="_static/images/github_button.png"/></a>
&nbsp;<a href="https://stackoverflow.com/questions/tagged/hyperledger-fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="StackOverflow" src="_static/images/stackoverflow_button.png"/></a>
&nbsp;<a href="https://chat.hyperledger.org"><img style="padding: 0px; margin: auto auto auto auto;" alt="Rocket Chat" src="_static/images/rocketchat_button.png"/></a>
&nbsp;<a href="https://www.youtube.com/playlist?list=PL0MZ85B_96CH7wvtrRzV7SvtRY0sI0DEg"><img style="padding: 0px; margin: auto auto auto auto;" alt="Youtube Channel" src="_static/images/youtube_button.png"/></a>

        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html">Hyperledger Fabric v2.0 更新说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html#id7">发行说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_concepts.html">关键概念</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="developapps/developing_applications.html">开发应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment_guide_overview.html">部署一个生产网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="ops_guide.html">操作指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade.html">升级到最新版本</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_ref.html">命令参考</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="architecture.html">架构参考</a><ul class="current">
<li class="toctree-l2"><a class="reference external" href="http://hyperledger-fabric-ca.readthedocs.io/en/latest">Hyperledger Fabric CA's User Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="fabric-sdks.html">Hyperledger Fabric SDK</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">交易流程</a></li>
<li class="toctree-l2"><a class="reference internal" href="discovery-overview.html">服务发现</a></li>
<li class="toctree-l2"><a class="reference internal" href="capability_requirements.html">定义功能需求</a></li>
<li class="toctree-l2"><a class="reference internal" href="channels.html">通道</a></li>
<li class="toctree-l2"><a class="reference internal" href="couchdb_as_state_database.html">使用 CouchDB 作为状态数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="peer_event_services.html">基于通道的 Peer 节点事件服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="private-data-arch.html">私有数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="readwrite.html">读写集语义</a></li>
<li class="toctree-l2"><a class="reference internal" href="gossip.html">Gossip 数据传播协议</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Fabric-FAQ.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">欢迎贡献！</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">术语表</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">版本发布</a></li>
<li class="toctree-l1"><a class="reference internal" href="questions.html">仍有问题？</a></li>
<li class="toctree-l1"><a class="reference internal" href="status.html">状态</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">hyperledger-fabricdocs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="architecture.html">架构参考</a> &raquo;</li>
        
      <li>交易流程</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/txflow.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>交易流程<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>本文讲解在一个标准的资产交换中的交易机制。该场景包含两个客户端 A 和 B，他们分别代表萝卜的买方和卖方。他们在网络上都有一个 Peer 节点，他们通过该节点来发送交易和与账本交互。</p>
<img alt="_images/step0.png" src="_images/step0.png" />
<p><strong>假设</strong></p>
<p>该流程中，假设已经设置了一个通道，并且该通道正常运行。应用程序的用户已经使用组织的 CA 注册和登记完成，并且拿到了用于在网络中用确认身份的加密材料。</p>
<p>链码（包含了萝卜商店初始状态的键值对）已经安装在 Peer 节点上并在通道上完成了实例化。链码中的逻辑定义了萝卜的交易和定价规则。链码也设置了一个背书策略，该策略是每一笔交易都必须被 <code class="docutils literal notranslate"><span class="pre">peerA</span></code> 和 <code class="docutils literal notranslate"><span class="pre">peerB</span></code> 都签名。</p>
<img alt="_images/step1.png" src="_images/step1.png" />
<ol class="arabic simple">
<li><p><strong>客户端 A 发起一笔交易</strong></p></li>
</ol>
<p>将会发生什么？客户端 A 发送一个采购萝卜的请求。该请求会到达 <code class="docutils literal notranslate"><span class="pre">peerA</span></code> 和 <code class="docutils literal notranslate"><span class="pre">peerB</span></code>，他们分别代表客户端 A 和客户端 B。背书策略要求所有交易都要两个节点背书，因此请求要到经过 <code class="docutils literal notranslate"><span class="pre">peerA</span></code> 和 <code class="docutils literal notranslate"><span class="pre">peerB</span></code>。</p>
<p>然后，要构建一个交易提案。应用程序使用所支持的 SDK（Node，Java，Python）中的 API 生成一个交易提案。提案是带有确定输入参数的调用链码方法的请求，该请求的作用是读取或者更新账本。</p>
<p>SDK 的作用是将交易提案打包成合适的格式（gRPC 使用的 protocol buffer）以及根据用户的密钥对交易提案生成签名。</p>
<img alt="_images/step2.png" src="_images/step2.png" />
<ol class="arabic simple" start="2">
<li><p><strong>背书节点验证签名并执行交易</strong></p></li>
</ol>
<p>背书节点验证（1）交易提案的格式完整，（2）且验证该交易提案之前没有被提交过（重放攻击保护），（3）验证签名是有效的（使用 MSP），（4）验证发起者（在这个例子中是客户端 A）有权在该通道上执行该操作（也就是说，每个背书节点确保发起者满足通道 <em>Writers</em> 策略）。背书节点将交易提案输入作为调用的链码函数的参数。然后根据当前状态数据库执行链码，生成交易结果，包括响应值、读集和写集（即表示要创建或更新的资产的键值对）。目前没有对账本进行更新。这些值以及背书节点的签名会一起作为“提案响应”返回到 SDK，SDK 会为应用程序解析该响应。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>MSP 是节点的组件，它允许 Peer 节点验证来自客户端的交易请求，并签署交易结果（即背书）。写入策略在通道创建时就会定义，用来确定哪些用户有权向该通道提交交易。有关成员关系的更多信息，请查看 <a class="reference internal" href="membership/membership.html"><span class="doc">&lt;no title&gt;</span></a> 文档。</p>
</div>
<img alt="_images/step3.png" src="_images/step3.png" />
<ol class="arabic simple" start="3">
<li><p><strong>检查提案响应</strong></p></li>
</ol>
<p>应用程序验证背书节点的签名，并比较这些提案响应，以确定其是否相同。如果链码只查询账本，应用程序将检查查询响应，并且通常不会将交易提交给排序服务。如果客户端应用程序打算向排序服务提交交易以更新账本，则应用程序在提交之前需确定是否已满足指定的背书策略（即 peerA 和 peerB 都要背书）。该结构是这样的，即使应用程序选择不检查响应或以其他方式转发未背书的交易，节点仍会执行背书策略，并在提交验证阶段遵守该策略。</p>
<img alt="_images/step4.png" src="_images/step4.png" />
<ol class="arabic simple" start="4">
<li><p><strong>客户端将背书结果封装进交易</strong></p></li>
</ol>
<p>应用程序将交易提案和“交易消息”中的交易响应“广播”给排序服务。交易会包含读写集，背书节点的签名和通道 ID。排序服务不需要为了执行其操作而检查交易的整个内容，它只是从网络中的所有通道接收交易，将它们按时间按通道排序，并将每个通道的交易打包成区块。</p>
<img alt="_images/step5.png" src="_images/step5.png" />
<ol class="arabic simple" start="5">
<li><p><strong>验证和提交交易</strong></p></li>
</ol>
<p>交易区块被“发送”给通道上的所有 Peer 节点。对区块内的交易进行验证，以确保满足背书策略，并确保自交易执行生成读集以来，读集中变量的账本状态没有变化。块中的交易会被标记为有效或无效。</p>
<img alt="_images/step6.png" src="_images/step6.png" />
<ol class="arabic simple" start="6">
<li><p><strong>账本更新</strong></p></li>
</ol>
<ol class="arabic simple" start="6">
<li><p><strong>Ledger updated</strong></p></li>
</ol>
<p>每个 Peer 节点都将区块追加到通道的链上，对于每个有效的交易，写集都提交到当前状态数据库。系统会发出一个事件，通知客户端应用程序本次交易（调用）已被不可更改地附加到链上，同时还会通知交易验证结果是有效还是无效。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>应用程序应该在提交交易后监听交易事件，例如使用 <code class="docutils literal notranslate"><span class="pre">submitTransaction</span></code> API，它会自动监听交易事件。如果不监听交易事件，您将不知道您的交易是否已经被排序、验证并提交到账本。</p>
</div>
<p>查看下边的泳道图来更好的理解交易流程。</p>
<img alt="_images/flow-4.png" src="_images/flow-4.png" />
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="discovery-overview.html" class="btn btn-neutral float-right" title="服务发现" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="fabric-sdks.html" class="btn btn-neutral" title="Hyperledger Fabric SDK" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Hyperledger 2020.
    <br>
      <br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>