

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>} &mdash; hyperledger-fabricdocs master documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="endorsementpolicies.html" />
    <link rel="prev" title="}" href="transactioncontext.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          


          
            <a href="../index.html" class="icon icon-home"> hyperledger-fabricdocs
          

          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

<br><img style="background-color: #fff; height: unset; width: unset;" alt="Hyperledger Fabric" src=../_images/hyperledger_fabric_logo_color.png />
<br>
<a href="https://github.com/hyperledger/fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="GitHub" src="../_static/images/github_button.png"/></a>
&nbsp;<a href="https://stackoverflow.com/questions/tagged/hyperledger-fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="StackOverflow" src="../_static/images/stackoverflow_button.png"/></a>
&nbsp;<a href="https://chat.hyperledger.org"><img style="padding: 0px; margin: auto auto auto auto;" alt="Rocket Chat" src="../_static/images/rocketchat_button.png"/></a>
&nbsp;<a href="https://www.youtube.com/playlist?list=PL0MZ85B_96CH7wvtrRzV7SvtRY0sI0DEg"><img style="padding: 0px; margin: auto auto auto auto;" alt="Youtube Channel" src="../_static/images/youtube_button.png"/></a>

        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../whatsnew.html">Hyperledger Fabric v2.0 更新说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whatsnew.html#id7">发行说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../key_concepts.html">关键概念</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">入门</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="developing_applications.html">开发应用</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id16">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id21">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id26">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id31">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id52">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id57">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id64">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id69">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id76">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id81">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id96">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id101">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id106">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id111">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id116">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartcontract.html#id121">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="application.html">};</a></li>
<li class="toctree-l2"><a class="reference internal" href="application.html#id20">}</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="designelements.html">应用程序设计元素</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="transactioncontext.html">}</a></li>
<li class="toctree-l3"><a class="reference internal" href="transactioncontext.html#id10">}</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">}</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">}</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment_guide_overview.html">部署一个生产网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ops_guide.html">操作指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrade.html">升级到最新版本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../command_ref.html">命令参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">架构参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Fabric-FAQ.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">欢迎贡献！</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">术语表</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">版本发布</a></li>
<li class="toctree-l1"><a class="reference internal" href="../questions.html">仍有问题？</a></li>
<li class="toctree-l1"><a class="reference internal" href="../status.html">状态</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">hyperledger-fabricdocs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="developing_applications.html">开发应用</a> &raquo;</li>
        
          <li><a href="designelements.html">应用程序设计元素</a> &raquo;</li>
        
      <li>}</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/developapps/transactionhandler.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p># 交易处理器</p>
<p><strong>受众</strong>：架构师，应用和智能合约开发者</p>
<p>交易处理器允许智能合约开发人员在应用程序和智能合约交互期间的关键点上定义通用处理。交易处理器是可选的，但是如果定义了，它们将在调用智能合约中的每个交易之前或之后接收控制权。还有一个特定的处理器，当请求调用未在智能合约中定义的交易时，该处理程序接收控制。</p>
<p>这里是一个[商业票据智能合约示例](./smartcontract.html)的交易处理器的例子：</p>
<p>![develop.transactionhandler](./develop.diagram.2.png)</p>
<p><em>前置、后置和未知交易处理器。在这个例子中，`beforeTransaction()` 在 **issue*</em>, <strong>buy</strong> 和 <strong>redeem</strong> 交易之前被调用。<cite>afterTransaction()</cite> 在 <strong>issue</strong>, <strong>buy</strong> 和 <strong>redeem</strong> 交易之后调用。<cite>UnknownFunction()</cite> 当请求调用未在智能合约中定义的交易时调用。（通过不为每个交易重复 <cite>beforeTransaction</cite> 和 <cite>afterTransaction</cite> 框来简化该图）*</p>
<p>## 处理器类型</p>
<p>有三种类型的交易处理器，它们涵盖应用程序和智能合约之间交互的不同方面：</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>前置处理器</strong>：在每个智能合约交易执行之前调用。该处理器通常用来改变交易使用的交易上下文。处理器可以访问所有 Fabric API；如，可以使用 <cite>getState()</cite> 和 <cite>putState()</cite>。</p></li>
<li><p><strong>后置处理器</strong>：在每个智能合约交易执行之后调用。处理器通常会对所有的交易执行通用的后置处理，同样可以访问所有的 Fabric API。</p></li>
<li><p><strong>未知处理器</strong>：试图执行未在智能合约中定义的交易时被调用。通常，处理器将记录管理员后续处理的失败。处理器可以访问所有的 Fabric API。</p></li>
</ul>
</div></blockquote>
<p>Defining a transaction handler is optional; a smart contract will perform
correctly without handlers being defined. A smart contract can define at most
one handler of each type.</p>
<p>## 定义处理器</p>
<p>交易处理器作为具有明确定义名称的方法添加到智能合约中。这是一个添加每种类型的处理器的示例：</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>JavaScript
CommercialPaperContract extends Contract {</p>
<blockquote>
<div><p>…</p>
<dl class="simple">
<dt>async beforeTransaction(ctx) {</dt><dd><p>// Write the transaction ID as an informational to the console
console.info(ctx.stub.getTxID());</p>
</dd>
</dl>
<p>};</p>
<dl class="simple">
<dt>async afterTransaction(ctx, result) {</dt><dd><p>// This handler interacts with the ledger
ctx.stub.cpList.putState(…);</p>
</dd>
</dl>
<p>};</p>
<dl class="simple">
<dt>async unknownTransaction(ctx) {</dt><dd><p>// This handler throws an exception
throw new Error(‘Unknown transaction function’);</p>
</dd>
</dl>
<p>};</p>
</div></blockquote>
<div class="section" id="id5">
<h1>}<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h1>
<p>交易处理器定义的形式对于所有处理程序类型都是类似的，但请注意 <cite>afterTransaction(ctx，result)</cite> 如何接收交易返回的任何结果。[API 文档](<a class="reference external" href="https://hyperledger.github.io/fabric-chaincode-node/master/api/fabric-contract-api.Contract.html">https://hyperledger.github.io/fabric-chaincode-node/master/api/fabric-contract-api.Contract.html</a>) 展示了这些处理器的准确格式。</p>
<p>## 处理器处理</p>
<p>一旦处理器添加到智能合约中，它可以在交易处理期间调用。在处理期间，处理器接收 <cite>ctx</cite> ，即[交易上下文](./transationcontext.md)，会执行一些处理，完成后返回控制权。继续如下的处理：</p>
<ul class="simple">
<li><p><strong>前置处理器</strong>：如果处理器成功完成，使用更新后的上下文调用交易。如果处理器抛出异常，不会调用交易，智能合约失败并显示异常错误消息。</p></li>
<li><p><strong>后置处理器</strong>：如果处理器成功完成，则智能合约将按调用的交易确定完成。如果处理程序抛出异常，则交易将失败并显示异常错误消息。</p></li>
<li><p><strong>未知处理器</strong>：处理器应该通过抛出包含所需错误消息的异常来完成。如果未指定**未知处理器**，或者未引发异常，则存在合理的默认处理;智能合约将以**未知交易**错误消息失败。</p></li>
</ul>
<p>如果处理器需要访问函数和参数，这很容易做到：</p>
<p><a href="#id6"><span class="problematic" id="id7">``</span></a><a href="#id8"><span class="problematic" id="id9">`</span></a>JavaScript
async beforeTransaction(ctx) {</p>
<blockquote>
<div><p>// Retrieve details of the transaction
let txnDetails = ctx.stub.getFunctionAndParameters();</p>
<p>console.info(<cite>Calling function: ${txnDetails.fcn} `);
console.info(util.format(`Function arguments : %j ${stub.getArgs()} `</cite>);</p>
</div></blockquote>
</div>
<div class="section" id="id10">
<h1>}<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h1>
<p>See how this handler uses the utility API <cite>getFunctionAndParameters</cite> via the
[transaction context](./transactioncontext.html#stub).</p>
<p>## 多处理器</p>
<p>It is only possible to define at most one handler of each type for a smart
contract. If a smart contract needs to invoke multiple functions during before,
after or unknown handling, it should coordinate this from within the appropriate
function.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="endorsementpolicies.html" class="btn btn-neutral float-right" title="&lt;no title&gt;" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="transactioncontext.html" class="btn btn-neutral" title="}" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Hyperledger 2020.
    <br>
      <br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>