

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>读写集语义 &mdash; hyperledger-fabricdocs master documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Gossip 数据传播协议" href="gossip.html" />
    <link rel="prev" title="私有数据" href="private-data-arch.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          


          
            <a href="index.html" class="icon icon-home"> hyperledger-fabricdocs
          

          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

<br><img style="background-color: #fff; height: unset; width: unset;" alt="Hyperledger Fabric" src=_images/hyperledger_fabric_logo_color.png />
<br>
<a href="https://github.com/hyperledger/fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="GitHub" src="_static/images/github_button.png"/></a>
&nbsp;<a href="https://stackoverflow.com/questions/tagged/hyperledger-fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="StackOverflow" src="_static/images/stackoverflow_button.png"/></a>
&nbsp;<a href="https://chat.hyperledger.org"><img style="padding: 0px; margin: auto auto auto auto;" alt="Rocket Chat" src="_static/images/rocketchat_button.png"/></a>
&nbsp;<a href="https://www.youtube.com/playlist?list=PL0MZ85B_96CH7wvtrRzV7SvtRY0sI0DEg"><img style="padding: 0px; margin: auto auto auto auto;" alt="Youtube Channel" src="_static/images/youtube_button.png"/></a>

        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html">Hyperledger Fabric v2.0 更新说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html#id7">发行说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_concepts.html">关键概念</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="developapps/developing_applications.html">开发应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment_guide_overview.html">部署一个生产网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="ops_guide.html">操作指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade.html">升级到最新版本</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_ref.html">命令参考</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="architecture.html">架构参考</a><ul class="current">
<li class="toctree-l2"><a class="reference external" href="http://hyperledger-fabric-ca.readthedocs.io/en/latest">Hyperledger Fabric CA's User Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="fabric-sdks.html">Hyperledger Fabric SDK</a></li>
<li class="toctree-l2"><a class="reference internal" href="txflow.html">交易流程</a></li>
<li class="toctree-l2"><a class="reference internal" href="discovery-overview.html">服务发现</a></li>
<li class="toctree-l2"><a class="reference internal" href="capability_requirements.html">定义功能需求</a></li>
<li class="toctree-l2"><a class="reference internal" href="channels.html">通道</a></li>
<li class="toctree-l2"><a class="reference internal" href="couchdb_as_state_database.html">使用 CouchDB 作为状态数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="peer_event_services.html">基于通道的 Peer 节点事件服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="private-data-arch.html">私有数据</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">读写集语义</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">交易模拟和读写集</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">交易验证和使用读写集更新世界状态</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">模拟和验证示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gossip.html">Gossip 数据传播协议</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Fabric-FAQ.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">欢迎贡献！</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">术语表</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">版本发布</a></li>
<li class="toctree-l1"><a class="reference internal" href="questions.html">仍有问题？</a></li>
<li class="toctree-l1"><a class="reference internal" href="status.html">状态</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">hyperledger-fabricdocs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="architecture.html">架构参考</a> &raquo;</li>
        
      <li>读写集语义</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/readwrite.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>读写集语义<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>本文档讨论有关读写集语义实现的详细信息。</p>
<div class="section" id="id2">
<h2>交易模拟和读写集<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">背书节点</span></code> 在模拟交易期间，会为交易准备一个读写集。<code class="docutils literal notranslate"><span class="pre">读集</span></code> 包含了模拟期间交易读取的键和键的版本的列表。<code class="docutils literal notranslate"><span class="pre">写集</span></code> 包含了交易写入键（可以与读取集中的键重叠）的新值。如果交易是删除一个键，该键就会被增加一个删除标识（在新值的位置）。</p>
</div></blockquote>
<p>如果交易多次向同一个键写入数据，只有最后写入的数据会记录下来。同样，如果交易读取一个键的值，就会返回这个键的已提交状态的值，即使读取之前在同一个交易中更新了键值。换句话说，不支持“读你所写”的语义。</p>
<p>就像前面所说的，键的版本只记录在读集中；写集只包含键和交易设置的键的最新值。</p>
<p>版本的实现有很多种。版本设计的基本需求是，键不能有重复的版本号。例如单调递增的数字。在目前的实现中，我们使用交易所在的区块高度来作为交易中所有修改的键的版本号。这样区块中交易的高度通过一个元组来表示（txNumber 是区块中交易的高度）。这种方式比递增的数字有更多好处，主要有，它可以让其他组件比如状态数据库、交易模拟和验证有更多的设计选择。</p>
<p>下边是为模拟一个交易所准备的读写集示例。为了简化说明，我们使用了一个递增的数字来表示版本。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">TxReadWriteSet</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">NsReadWriteSet</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;chaincode1&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">read</span><span class="o">-</span><span class="nb">set</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">read</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;K1&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">read</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;K2&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">read</span><span class="o">-</span><span class="nb">set</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">write</span><span class="o">-</span><span class="nb">set</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">write</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;K1&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;V1&quot;</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">write</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;K3&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;V2&quot;</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">write</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;K4&quot;</span><span class="p">,</span> <span class="n">isDelete</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">write</span><span class="o">-</span><span class="nb">set</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">NsReadWriteSet</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">TxReadWriteSet</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>另外，如果交易在模拟中执行的是一个范围查询，范围查询和它的结果都会被记录在读写集的 <code class="docutils literal notranslate"><span class="pre">查询信息（query-info）</span></code> 中。</p>
</div>
<div class="section" id="id3">
<h2>交易验证和使用读写集更新世界状态<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">提交节点</span></code> 使用读写集中的读集来验证交易，使用写集来更新受影响的键的版本和值。</p>
<p>在验证阶段，如果读集中键的版本和世界状态中键的版本一致就认为该交易是 <code class="docutils literal notranslate"><span class="pre">有效的</span></code> ，这里我们假设所有之前 <code class="docutils literal notranslate"><span class="pre">有效</span></code> 的交易（同一个区块中该交易之前的交易）都会被提交（<em>提交状态</em>）。当读写集中包含一个或多个查询信息（query-info）时，需要执行额外的验证。</p>
<p>这种额外的验证需要确保在根据查询信息获得的结果的超集（多个范围的合并）中没有插入、删除或者更新键。换句话说，如果我们在模拟执行交易期间重新执行任何一个范围，我们应该得到相同的结果。这个检查保证了如果交易在提交期间出了虚项，该交易就会被标记为无效的。这种检查只存在于范围查询中（例如链码中的 <code class="docutils literal notranslate"><span class="pre">GetStateByRange</span></code> 方法）其他查询中没有实现（例如链码中的 <code class="docutils literal notranslate"><span class="pre">GetQueryResult</span></code> 方法）。其他查询仍会存在出现虚项的风险，我们应该只在不向排序服务提交的只读交易中使用查询，除非应用程序能保证模拟的结果和验证/提交时的结果一致。</p>
<p>如果交易通过了有效性验证，提交节点就会根据写集更新世界状态。在更新阶段，会根据写集更新世界状态中对应的键的值。然后，世界状态中键的版本会更新到最新的版本。</p>
</div>
<div class="section" id="id4">
<h2>模拟和验证示例<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>本章节通过示例场景帮助你理解读写集语义。在本例中，<code class="docutils literal notranslate"><span class="pre">k</span></code> 表示键，在世界状态中表示一个元组 <code class="docutils literal notranslate"><span class="pre">(k,ver,val)</span></code> ， <code class="docutils literal notranslate"><span class="pre">ver</span></code> 是键 <code class="docutils literal notranslate"><span class="pre">k</span></code> 的版本， <code class="docutils literal notranslate"><span class="pre">val</span></code> 是值。</p>
<p>现在假设有五个交易 <code class="docutils literal notranslate"><span class="pre">T1，T2，T3，T4</span> <span class="pre">和</span> <span class="pre">T5</span></code> ，所有的交易模拟都基于同一个世界状态的快照。下边的步骤展示了世界状态和模拟这些交易时的读写活动。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">World</span> <span class="n">state</span><span class="p">:</span> <span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">v1</span><span class="p">),</span> <span class="p">(</span><span class="n">k2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">v2</span><span class="p">),</span> <span class="p">(</span><span class="n">k3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">v3</span><span class="p">),</span> <span class="p">(</span><span class="n">k4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">v4</span><span class="p">),</span> <span class="p">(</span><span class="n">k5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">v5</span><span class="p">)</span>
<span class="n">T1</span> <span class="o">-&gt;</span> <span class="n">Write</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">v1</span><span class="s1">&#39;), Write(k2, v2&#39;</span><span class="p">)</span>
<span class="n">T2</span> <span class="o">-&gt;</span> <span class="n">Read</span><span class="p">(</span><span class="n">k1</span><span class="p">),</span> <span class="n">Write</span><span class="p">(</span><span class="n">k3</span><span class="p">,</span> <span class="n">v3</span><span class="s1">&#39;)</span>
<span class="n">T3</span> <span class="o">-&gt;</span> <span class="n">Write</span><span class="p">(</span><span class="n">k2</span><span class="p">,</span> <span class="n">v2</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">T4</span> <span class="o">-&gt;</span> <span class="n">Write</span><span class="p">(</span><span class="n">k2</span><span class="p">,</span> <span class="n">v2</span><span class="s1">&#39;&#39;&#39;), read(k2)</span>
<span class="s1">T5 -&gt; Write(k6, v6&#39;), read(k5)</span>
</pre></div>
</div>
<p>现在，假设这些交易的顺序是从 T1 到 T5（他们可以在同一个区块，也可以在不同区块）</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">T1</span></code> 通过了验证，因为它没有执行任何读操作。然后世界状态中的键 <code class="docutils literal notranslate"><span class="pre">k1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">k2</span></code> 被更新为 <code class="docutils literal notranslate"><span class="pre">(k1,2,v1'),</span> <span class="pre">(k2,2,v2')</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">T2</span></code> 没有通过验证，因为它读了键 <code class="docutils literal notranslate"><span class="pre">k1</span></code>，但是交易 <code class="docutils literal notranslate"><span class="pre">T1</span></code> 改变了 <code class="docutils literal notranslate"><span class="pre">k1</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">T3</span></code> 通过了验证，因为它没有执行任何读操作。然后世界状态中的键 <code class="docutils literal notranslate"><span class="pre">k2</span></code> 被更新为 <code class="docutils literal notranslate"><span class="pre">(k2,3,v2'')</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">T4</span></code> 没有通过验证，因为它读了键 <code class="docutils literal notranslate"><span class="pre">k2</span></code>，但是交易 <code class="docutils literal notranslate"><span class="pre">T1</span></code> 改变了 <code class="docutils literal notranslate"><span class="pre">k2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">T5</span></code> 通过了验证，因为它读了键 <code class="docutils literal notranslate"><span class="pre">k5</span></code>，但是 <code class="docutils literal notranslate"><span class="pre">k5</span></code> 没有被其他任何交易改变</p></li>
</ol>
<p><strong>Note</strong>: 不支持有多个读写集的交易。</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="gossip.html" class="btn btn-neutral float-right" title="Gossip 数据传播协议" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="private-data-arch.html" class="btn btn-neutral" title="私有数据" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Hyperledger 2020.
    <br>
      <br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>