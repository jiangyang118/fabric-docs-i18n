

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Gossip 数据传播协议 &mdash; hyperledger-fabricdocs master documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="常见问题" href="Fabric-FAQ.html" />
    <link rel="prev" title="读写集语义" href="readwrite.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          


          
            <a href="index.html" class="icon icon-home"> hyperledger-fabricdocs
          

          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

<br><img style="background-color: #fff; height: unset; width: unset;" alt="Hyperledger Fabric" src=_images/hyperledger_fabric_logo_color.png />
<br>
<a href="https://github.com/hyperledger/fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="GitHub" src="_static/images/github_button.png"/></a>
&nbsp;<a href="https://stackoverflow.com/questions/tagged/hyperledger-fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="StackOverflow" src="_static/images/stackoverflow_button.png"/></a>
&nbsp;<a href="https://chat.hyperledger.org"><img style="padding: 0px; margin: auto auto auto auto;" alt="Rocket Chat" src="_static/images/rocketchat_button.png"/></a>
&nbsp;<a href="https://www.youtube.com/playlist?list=PL0MZ85B_96CH7wvtrRzV7SvtRY0sI0DEg"><img style="padding: 0px; margin: auto auto auto auto;" alt="Youtube Channel" src="_static/images/youtube_button.png"/></a>

        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html">Hyperledger Fabric v2.0 更新说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html#id7">发行说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_concepts.html">关键概念</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="developapps/developing_applications.html">开发应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment_guide_overview.html">部署一个生产网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="ops_guide.html">操作指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade.html">升级到最新版本</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_ref.html">命令参考</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="architecture.html">架构参考</a><ul class="current">
<li class="toctree-l2"><a class="reference external" href="http://hyperledger-fabric-ca.readthedocs.io/en/latest">Hyperledger Fabric CA's User Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="fabric-sdks.html">Hyperledger Fabric SDK</a></li>
<li class="toctree-l2"><a class="reference internal" href="txflow.html">交易流程</a></li>
<li class="toctree-l2"><a class="reference internal" href="discovery-overview.html">服务发现</a></li>
<li class="toctree-l2"><a class="reference internal" href="capability_requirements.html">定义功能需求</a></li>
<li class="toctree-l2"><a class="reference internal" href="channels.html">通道</a></li>
<li class="toctree-l2"><a class="reference internal" href="couchdb_as_state_database.html">使用 CouchDB 作为状态数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="peer_event_services.html">基于通道的 Peer 节点事件服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="private-data-arch.html">私有数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="readwrite.html">读写集语义</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Gossip 数据传播协议</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Gossip 协议</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">主节点选举</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">静态主节点选举</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">动态主节点选举</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id5">锚节点</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#endpoint">外部和内部端点（endpoint）</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id6">Gossip 消息</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Fabric-FAQ.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">欢迎贡献！</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">术语表</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">版本发布</a></li>
<li class="toctree-l1"><a class="reference internal" href="questions.html">仍有问题？</a></li>
<li class="toctree-l1"><a class="reference internal" href="status.html">状态</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">hyperledger-fabricdocs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="architecture.html">架构参考</a> &raquo;</li>
        
      <li>Gossip 数据传播协议</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/gossip.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="gossip">
<h1>Gossip 数据传播协议<a class="headerlink" href="#gossip" title="Permalink to this headline">¶</a></h1>
<p>Hyperledger Fabric 通过将工作负载拆分为交易执行（背书和提交）节点和交易排序节点的方式来优化区块链网络的性能、安全性和可扩展性。这样对网络的分割就需要一个安全、可靠和可扩展的数据传播协议来保证数据的完整性和一致性。为了满足这个需求，Fabric 实现了 <strong>Gossip 数据传播协议</strong> 。</p>
<div class="section" id="id1">
<h2>Gossip 协议<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Peer 节点通过 gossip 协议来传播账本和通道数据。Gossip 消息是持续的，通道中的每一个 Peer 节点不断地从多个节点接收当前一致的账本数据。每一个 gossip 消息都是带有签名的，因此拜占庭成员发送的伪造消息很容易就会被识别，并且非目标节点也不会接受与其无关的消息。Peer 节点会受到延迟、网络分区或者其他原因影响而丢失区块，这时节点会通过从其他拥有这些丢失区块的节点处同步账本。</p>
<p>基于 gossip 的数据传播协议在 Fabric 网络中有三个主要功能：</p>
<ol class="arabic simple">
<li><p>通过持续的识别可用的成员节点来管理节点发现和通道成员，还有检测离线节点。</p></li>
<li><p>向通道中的所有节点传播账本数据。所有没有和当前通道的数据同步的节点会识别丢失的区块，并将正确的数据复制过来以使自己同步。</p></li>
<li><p>通过点对点的数据传输方式，使新节点以最快速度连接到网络中并同步账本数据。</p></li>
</ol>
<p>Peer 节点基于 gossip 的数据广播操作接收通道中其他的节点的信息，然后将这些信息随机发送给通道上的一些其他节点，随机发送的节点数量是一个可配置的常量。Peer 节点可以用“拉”的方式获取信息而不用一直等待。这是一个重复的过程，以使通道中的成员、账本和状态信息同步并保持最新。在分发新区块的时候，通道中 <strong>主</strong> 节点从排序服务拉取数据然后分发给它所在组织的节点。</p>
</div>
<div class="section" id="id2">
<h2>主节点选举<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>主节点的选举机制用于在每一个组织中 <strong>选举</strong> 出一个用于链接排序服务和开始分发新区块的节点。主节点选举使得系统可以有效地利用排序服务的带宽。主节点选举模型有两种模式可供选择：</p>
<ol class="arabic simple">
<li><p><strong>静态模式</strong>：系统管理员手动配置一个节点为组织的主节点。</p></li>
<li><p><strong>动态模式</strong>：组织中的节点自己选举出一个主节点。</p></li>
</ol>
<div class="section" id="id3">
<h3>静态主节点选举<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>静态主节点选举允许你手动设置组织中的一个或多个节点节点为主节点。请注意，太多的节点连接到排序服务可能会影响带宽使用效率。要开启静态主节点选举模式，需要配置 <code class="docutils literal notranslate"><span class="pre">core.yaml</span></code> 中的如下部分：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">peer</span><span class="p">:</span>
    <span class="c1"># Gossip related configuration</span>
    <span class="n">gossip</span><span class="p">:</span>
        <span class="n">useLeaderElection</span><span class="p">:</span> <span class="n">false</span>
        <span class="n">orgLeader</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<p>另外，这些配置的参数可以通过环境变量覆盖：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">CORE_PEER_GOSSIP_USELEADERELECTION</span><span class="o">=</span><span class="n">false</span>
<span class="n">export</span> <span class="n">CORE_PEER_GOSSIP_ORGLEADER</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>下边的设置会使节点进入 <strong>旁观者</strong> 模式，也就是说，它不会试图成为一个主节点：</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">CORE_PEER_GOSSIP_USELEADERELECTION</span><span class="o">=</span><span class="n">false</span>
<span class="n">export</span> <span class="n">CORE_PEER_GOSSIP_ORGLEADER</span><span class="o">=</span><span class="n">false</span>
</pre></div>
</div>
<p>不要将 <code class="docutils literal notranslate"><span class="pre">CORE_PEER_GOSSIP_USELEADERELECTION</span></code> 和 <code class="docutils literal notranslate"><span class="pre">CORE_PEER_GOSSIP_ORGLEADER</span></code> 都设置为 <code class="docutils literal notranslate"><span class="pre">true</span></code>，这将会导致错误。</p>
<p>使用静态配置时，主节点失效或者崩溃都需要管理员进行处理。</p>
</div>
<div class="section" id="id4">
<h3>动态主节点选举<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>动态主节点选举使组织中的节点可以 <strong>选举</strong> 一个节点来连接排序服务并拉取新区块。这个主节点由每个组织单独选举。</p>
<p>动态选举出的主节点通过向其他节点发送 <strong>心跳</strong> 信息来证明自己处于存活状态。如果一个或者更多的节点在一个段时间内没有收到 <strong>心跳</strong> 信息，它们就会选举出一个新的主节点。</p>
<p>在网络比较差有多个网络分区存在的情况下，组织中会存在多个主节点以保证组织中节点的正常工作。在网络恢复正常之后，其中一个主节点会放弃领导权。在一个没有网络分区的稳定状态下，会只有 <strong>唯一</strong> 一个活动的主节点和排序服务相连。</p>
<p>下边的配置控制主节点 <strong>心跳</strong> 信息的发送频率：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">peer</span><span class="p">:</span>
    <span class="c1"># Gossip related configuration</span>
    <span class="n">gossip</span><span class="p">:</span>
        <span class="n">election</span><span class="p">:</span>
            <span class="n">leaderAliveThreshold</span><span class="p">:</span> <span class="mi">10</span><span class="n">s</span>
</pre></div>
</div>
<p>开启动态节点选举，需要配置 <code class="docutils literal notranslate"><span class="pre">core.yaml</span></code> 中的以下参数：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">peer</span><span class="p">:</span>
    <span class="c1"># Gossip related configuration</span>
    <span class="n">gossip</span><span class="p">:</span>
        <span class="n">useLeaderElection</span><span class="p">:</span> <span class="n">true</span>
        <span class="n">orgLeader</span><span class="p">:</span> <span class="n">false</span>
</pre></div>
</div>
<p>同样，这些配置的参数可以通过环境变量覆盖：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">CORE_PEER_GOSSIP_USELEADERELECTION</span><span class="o">=</span><span class="n">true</span>
<span class="n">export</span> <span class="n">CORE_PEER_GOSSIP_ORGLEADER</span><span class="o">=</span><span class="n">false</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h2>锚节点<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>gossip 利用锚节点来保证不同组织间的互相通信。</p>
<p>当提交了一个包含锚节点更新的配置区块时，Peer 节点会连接到锚节点并获取它所知道的所有节点信息。一个组织中至少有一个节点连接到了锚节点，锚节点就可以获取通道中所有节点的信息。因为 gossip 的通信是固定的，而且 Peer 节点总会被告知它们不知道的节点，所以可以建立起一个通道上成员的视图。</p>
<p>例如，假设我们在一个通道有三个组织 <cite>A</cite>、<cite>B</cite> 和 <cite>C</cite>，组织 <cite>C</cite> 定义了锚节点 <cite>peer0.orgC</cite>。当 <cite>peer1.orgA</cite> 连接到 <cite>peer0.orgC</cite> 时，它将会告诉 <cite>peer0.orgC</cite> 有关 <cite>peer0.orgA</cite> 的信息。稍后等 <cite>peer1.orgB</cite> 连接到 <cite>peer0.orgC</cite> 时，后者也会告诉前者关于 <cite>peer0.orgA</cite> 的信息。在这之后，组织 <cite>A</cite> 和组织 <cite>B</cite> 可以开始直接交换成员信息而无需借助 <cite>peer0.orgC</cite> 了。</p>
<p>由于组织间的通信依赖于 gossip，所以在通道配置中必须至少有一个锚节点。为了系统的可用性和冗余性，我们强烈建议每个组织都提供自己的一些锚节点。注意，锚节点不一定和主节点是同一个节点。</p>
<div class="section" id="endpoint">
<h3>外部和内部端点（endpoint）<a class="headerlink" href="#endpoint" title="Permalink to this headline">¶</a></h3>
<p>为了让 gossip 高效地工作，Peer 节点需要包含其所在组织以及其他组织的端点信息。</p>
<p>当 Peer 节点启动的时候，它会使用 <code class="docutils literal notranslate"><span class="pre">core.yaml</span></code> 文件中的 <code class="docutils literal notranslate"><span class="pre">peer.gossip.bootstrap</span></code> 来宣传自己并交换成员信息，同时建立所属组织中可用节点的视图。</p>
<p><code class="docutils literal notranslate"><span class="pre">core.yaml</span></code> 文件中的 <code class="docutils literal notranslate"><span class="pre">peer.gossip.bootstrap</span></code> 属性用于在 <strong>一个组织内部</strong> 启动 gossip。如果你要使用 gossip，通常要为组织中的所有节点配置一组启动节点（使用空格隔开的节点列表）。内部端点通常是由 Peer 节点自动计算的，或者在 <code class="docutils literal notranslate"><span class="pre">core.yaml</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">core.peer.address</span></code> 指明。如果你要覆盖该值，你可以设置环境变量 <code class="docutils literal notranslate"><span class="pre">CORE_PEER_GOSSIP_ENDPOINT</span></code>。</p>
<p>启动信息也同样需要建立 <strong>跨组织</strong> 的通信。初始的跨组织启动信息通过上面所说的“锚节点”设置提供。如果想让其他组织知道你所在组织中的其他节点，你需要设置 <code class="docutils literal notranslate"><span class="pre">core.yaml</span></code> 文件中的 <code class="docutils literal notranslate"><span class="pre">peer.gossip.externalendpoint</span></code>。如果没有设置，节点的端点信息就不会广播到其他组织的 Peer 节点。</p>
<p>这些属性的设置如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">CORE_PEER_GOSSIP_BOOTSTRAP</span><span class="o">=&lt;</span><span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">peer</span> <span class="n">endpoints</span> <span class="n">within</span> <span class="n">the</span> <span class="n">peer</span><span class="s1">&#39;s org&gt;</span>
<span class="n">export</span> <span class="n">CORE_PEER_GOSSIP_EXTERNALENDPOINT</span><span class="o">=&lt;</span><span class="n">the</span> <span class="n">peer</span> <span class="n">endpoint</span><span class="p">,</span> <span class="k">as</span> <span class="n">known</span> <span class="n">outside</span> <span class="n">the</span> <span class="n">org</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2>Gossip 消息<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>在线的节点通过持续广播“存活”消息来表明其处于可用状态，每一条消息都包含了“公钥基础设施（PKI）” ID 和发送者的签名。节点通过收集这些存活的消息来维护通道成员。如果没有节点收到某个节点的存活信息，这个“死亡”的节点会被从通道成员关系中剔除。因为“存活”的消息是经过签名的，恶意节点无法假冒其他节点，因为他们没有根 CA 签发的密钥。</p>
<p>除了自动转发接收到的消息之外，状态协调进程还会在每个通道上的 Peer 节点之间同步 <strong>世界状态</strong>。每个 Peer 节点都持续从通道中的其他节点拉取区块，来修复他们缺失的状态。因为基于 gossip 的数据分发不需要固定的连接，所以该过程可以可靠地提供共享账本的一致性和完整性，包括对节点崩溃的容忍。</p>
<p>因为通道是隔离的，所以一个通道中的节点无法和其他通道通信或者共享信息。尽管节点可以加入多个通道，但是分区消息传递通过基于 Peer 节点所在通道的应用消息的路由策略，来防止区块被分发到其他通道的 Peer 节点。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ol class="arabic simple">
<li><p>通过 Peer 节点 TLS 层来处理点对点消息的安全性，不需要使用签名。Peer 节点通过 CA 签发的证书来授权。尽管没有使用 TLS 证书，但在 gossip 层使用了经过授权的 Peer 节点证书。账本区块经过排序服务签名，然后被分发到通道上的主节点。</p></li>
<li><p>通过 Peer 节点的成员服务提供者来管理授权。当 Peer 节点第一次连接到通道时，TLS 会话将与成员身份绑定。这就利用网络和通道中成员的身份来验证了与 Peer 节点相连的节点的身份。</p></li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Fabric-FAQ.html" class="btn btn-neutral float-right" title="常见问题" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="readwrite.html" class="btn btn-neutral" title="读写集语义" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Hyperledger 2020.
    <br>
      <br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>